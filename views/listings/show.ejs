<% layout('layouts/boilerplate') %>
<div class="container my-5">
    <div class="listing-card rounded-4 overflow-hidden shadow-sm">
        <div class="row g-0 align-items-stretch">
            <div class="col-12 col-md-5">
                <div class="position-relative h-100">
                    <img src="<%= listing.thumbnail %>" alt="<%= listing.title %>" class="card-img-top" style="height:100%; min-height:260px;">
                    <span class="position-absolute top-0 end-0 m-3 badge bg-gradient fs-6 shadow">
                        &#8377;<%= (listing.fee || 0).toLocaleString("en-IN") %>
                    </span>
                </div>
            </div>
            <div class="col-12 col-md-7">
                <div class="card-body p-4 p-md-5">
                    <h1 class="display-6 fw-bold mb-2"><%= listing.title %></h1>
                    <p class="mb-1 text-muted">by <span class="fw-semibold text-primary"><%= listing.owner.username %></span></p>
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <span class="badge bg-light text-muted"><i class="bi bi-tags-fill me-1"></i> <%= listing.category %></span>
                        <span class="badge bg-light text-muted"><i class="bi bi-clock-fill me-1"></i> <%= listing.duration %></span>
                        <% if (listing.level) { %>
                            <span class="badge bg-light text-muted"><i class="bi bi-bar-chart-fill me-1"></i> <%= listing.level %></span>
                        <% } %>
                    </div>

                    <div class="mb-4 text-secondary listing-description" style="line-height:1.6">
                        <% if (listing.description) { %>
                            <% 
                                function escapeHtml(str) { if (!str) return ''; return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&#39;'); }
                                const descHtml = listing.description.split(/\r?\n\r?\n/).map(par => '<p>' + par.split(/\r?\n/).map(line => escapeHtml(line)).join('<br/>') + '</p>').join('');
                            %>
                            <%- descHtml %>
                        <% } else { %>
                            <p class="text-muted">No description provided.</p>
                        <% } %>
                    </div>

                    <div class="mb-4 d-flex gap-2">
                        <% if (listing.url) { %>
                            <a href="<%= listing.url %>" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary rounded-pill px-4 py-2">
                                <i class="bi bi-box-arrow-up-right me-2"></i> Open Course
                            </a>
                        <% } %>

                        <% /* Save form removed: owners can use Edit to change listing details */ %>

                        <% if (currentUser && (currentUser._id.toString() === listing.owner._id.toString())) { %>
                            <a href="/listings/<%= listing._id %>/edit" class="btn btn-gradient-primary rounded-pill px-3 py-2 ms-auto">
                                <i class="bi bi-pencil-square me-1"></i> Edit
                            </a>
                            <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="ms-2">
                                <button type="submit" class="btn btn-gradient-danger rounded-pill px-3 py-2"><i class="bi bi-trash me-1"></i> Delete</button>
                            </form>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12 col-lg-6">
            <div class="card rounded-4 shadow-sm p-4">
                <h4 class="mb-3">Student Reviews</h4>
                <% if (listing.reviews && listing.reviews.length) { %>
                    <% for (let review of listing.reviews) { %>
                        <div class="d-flex mb-3">
                            <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-3" style="width:44px; height:44px; font-weight:700; font-size:1.05rem;">
                                <%= review.author.username.charAt(0).toUpperCase() %>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1"><%= review.author.username %></h6>
                                        <div class="text-warning">
                                            <% for(let i=0; i<review.rating; i++) { %>
                                                <i class="bi bi-star-fill"></i>
                                            <% } %>
                                            <% for(let i=review.rating; i<5; i++) { %>
                                                <i class="bi bi-star"></i>
                                            <% } %>
                                        </div>
                                    </div>
                                    <small class="text-muted">&nbsp;</small>
                                </div>
                                <p class="mb-1 text-secondary" style="white-space: pre-wrap;"><%= review.comment %></p>
                                <form class="mt-2" method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                                    <button class="btn btn-sm btn-outline-dark">Delete</button>
                                </form>
                            </div>
                        </div>
                    <% } %>
                <% } else { %>
                    <p class="text-muted">Be the first to review this course.</p>
                <% } %>
            </div>
        </div>

        <div class="col-12 col-lg-6 mt-3 mt-lg-0">
            <div class="card rounded-4 shadow-sm p-4">
                <h4 class="mb-3">Leave a Review</h4>
                <% if (currentUser) { %>
                    <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Rating</label>
                            <div class="starability-slot" role="radiogroup" aria-label="Rating">
                                <input class="input-no-rate" type="radio" name="review[rating]" id="no-rate" value="0" checked />
                                <% for(let i=1; i<=5; i++) { %>
                                    <input type="radio" name="review[rating]" id="star<%= i %>" value="<%= i %>">
                                    <label for="star<%= i %>" title="<%= i %> stars"><%= i %> stars</label>
                                <% } %>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="comment" class="form-label fw-semibold">Comments</label>
                            <textarea name="review[comment]" id="comment" cols="30" rows="4" class="form-control" placeholder="Share your experience..." required></textarea>
                            <div class="invalid-feedback">Please add some comments for review</div>
                        </div>
                        <button type="submit" class="btn btn-success rounded-pill px-4 py-2">
                            <i class="bi bi-send me-1"></i> Submit Review
                        </button>
                    </form>
                <% } else { %>
                    <p>Please <a href="/login">login</a> to leave a review.</p>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<script>
    // Basic client validation (bootstrap-style)
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })()
</script>